<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ticket Scanner</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a84ff">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icon-192.png" />

<style>
  :root{ --fg:#0b0b0c; --muted:#6b7280; --tint:#0a84ff; --shadow:0 12px 30px rgba(0,0,0,.10); --bot-offset:16px; }
  html,body{height:100dvh; min-height:100dvh}
  body{
    margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#fff 0%,#eef2f7 100%);
    color:var(--fg);
    overflow:hidden; overscroll-behavior:none; -webkit-font-smoothing:antialiased;
  }
  .safe-top{padding-top:calc(env(safe-area-inset-top)+16px)}
  .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom)+16px)}
  .center{position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:22px}

  .btn{-webkit-tap-highlight-color:transparent;border:0;cursor:pointer;font-weight:800;letter-spacing:.2px;border-radius:16px;transition:transform .06s}
  .btn:active{transform:translateY(1px) scale(.98)}
  .btn-primary{background:var(--tint);color:#fff;padding:18px 26px;font-size:18px;box-shadow:var(--shadow)}
  .app-title{font-weight:900;font-size:22px;text-align:center;margin:0}

  .camera-box{position:relative;width:min(88vw,620px);aspect-ratio:1/1;border-radius:24px;overflow:hidden;background:#000;border:1px solid rgba(0,0,0,.18);box-shadow:0 18px 44px rgba(0,0,0,.22),inset 0 0 0 1px rgba(255,255,255,.06)}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
  .corners{position:absolute;inset:12px;border-radius:18px;border:3px solid rgba(255,255,255,.92);pointer-events:none}

  .dock{display:flex;gap:12px;justify-content:center}
  .pill{
    display:inline-flex;align-items:center;gap:10px;
    border-radius:999px;padding:12px 18px;background:#fff;
    border:1px solid rgba(0,0,0,.06); box-shadow:0 8px 20px rgba(0,0,0,.08);
    font-weight:800
  }
  .pill .dot{width:10px;height:10px;border-radius:50%;background:#d1d5db;box-shadow:0 0 0 2px rgba(0,0,0,.06)}
  .pill.on .dot{background:#34c759; box-shadow:0 0 0 2px rgba(52,199,89,.25)}

  /* VIEWER */
  #viewer{position:fixed; inset:0; display:none; background:#fff}
  #frame{position:absolute; inset:0; width:100%; height:100%; border:0; opacity:0; transition:opacity .25s ease}
  #backToScan{
    position:fixed; left:5%; right:5%;
    bottom:calc(env(safe-area-inset-bottom) + var(--bot-offset));
    padding:16px 18px; background:rgba(10,132,255,.92); color:#fff;
    border-radius:18px; font-weight:1500; text-align:center;
    box-shadow:0 10px 30px rgba(10,132,255,.35), 0 1px 0 rgba(255,255,255,.35) inset;
    backdrop-filter:saturate(180%) blur(12px); border:1px solid rgba(255,255,255,.55);
  }

  /* Toast + Help overlay */
  #toast{position:fixed; left:50%; bottom:40%; transform:translate(-50%,50%); background:rgba(0,0,0,.88); color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; opacity:0; transition:opacity .25s}
  #toast.show{opacity:.95}
  #help{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    backdrop-filter:blur(4px); background:rgba(255,255,255,.8); z-index:6; text-align:center; padding:24px;
    color:#111
  }
  #help .box{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:20px;box-shadow:var(--shadow);padding:20px;max-width:520px}
  #help .box h3{margin:0 0 6px;font-size:20px}
  #help .box p{margin:8px 0 14px;color:#555}
  #help .box .row{display:flex;gap:10px;justify-content:center}
  #help .box button{padding:12px 16px;border-radius:12px;border:1px solid rgba(0,0,0,.06);background:#0a84ff;color:#fff;font-weight:800}

  /* Loading overlay */
  #loader{
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#fff 0%, #f6f7fb 100%); z-index:5; opacity:0; pointer-events:none; transition:opacity .25s ease;
  }
  #loader.active{opacity:1}
  .spinner{width:38px;height:38px;border-radius:50%;border:3px solid rgba(0,0,0,.12);border-top-color:#0a84ff;animation:spin .9s linear infinite}
  .loading-text{margin-top:12px;color:#6b7280;font-weight:700;letter-spacing:.2px;font-size:13px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- START (zonder witte kaart) -->
<section id="start" class="center">
  <h1 class="app-title safe-top">Ticket Scanner</h1>
  <p style="margin:0; padding:0 28px; text-align:center; color:var(--muted)">Use the rear camera. Flash & sound available in scanner.</p>
  <button id="startBtn" class="btn btn-primary">Start</button>
</section>

<!-- SCANNER -->
<section id="scanner" class="center" style="display:none">
  <h1 class="app-title safe-top">Scanner</h1>
  <div class="camera-box">
    <video id="video" playsinline muted></video>
    <div class="corners"></div>
  </div>
  <div class="dock safe-bottom">
    <button id="flashBtn" class="pill">ðŸ”¦ Flash <span class="dot"></span></button>
    <button id="soundBtn" class="pill">ðŸŽ§ Sound <span class="dot"></span></button>
  </div>
</section>

<!-- VIEWER -->
<section id="viewer">
  <div id="loader" class="active">
    <div class="spinner"></div>
    <div class="loading-text">Loading ticketâ€¦</div>
  </div>
  <iframe id="frame" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
  <button id="backToScan">â†©ï¸Ž Back to Scanner</button>
</section>

<div id="help">
  <div class="box">
    <h3>Camera access needed</h3>
    <p>Allow camera access in the prompt, or enable it in Settings. Then tap Retry.</p>
    <div class="row"><button id="retryBtn">Retry</button></div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
/* ---------- Elements ---------- */
const start=document.getElementById('start'),scanner=document.getElementById('scanner'),viewer=document.getElementById('viewer');
const frame=document.getElementById('frame'),loader=document.getElementById('loader'),startBtn=document.getElementById('startBtn');
const flashBtn=document.getElementById('flashBtn'),soundBtn=document.getElementById('soundBtn'),backBtn=document.getElementById('backToScan');
const retryBtn=document.getElementById('retryBtn'),help=document.getElementById('help'),video=document.getElementById('video'),toast=document.getElementById('toast');

const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
document.documentElement.style.setProperty('--bot-offset', isStandalone ? '16px' : '72px');

/* ---------- State ---------- */
let audioCtx,beepOn=true,currentStream,torchOn=false,lastText='';
let rafId=null,frameCB=null,running=false,usingBarcodeDetector=false,isScannerActive=false;

/* ---------- Haptics + Beep ---------- */
function hapticSuccess(){try{
  if(navigator.haptics?.notificationOccurred) navigator.haptics.notificationOccurred('success');
  else if(navigator.vibrate) navigator.vibrate(10);
}catch(_){}
}
function ensureAudio(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') return audioCtx.resume();
  return Promise.resolve();
}
function beep(){
  if(!beepOn) return;
  ensureAudio().then(()=>{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.15);
    o.start(); o.stop(audioCtx.currentTime+0.17);
  });
}
function toastMsg(m){toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1000);}

/* ---------- Camera ---------- */
async function startCamera(){
  stopScan(); // hard stop
  help.style.display='none';
  if(!isScannerActive) return false; // respect mode: only start in scanner mode
  try{
    currentStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},audio:false});
    video.srcObject=currentStream; await video.play().catch(()=>{});
    startLoops();
    return true;
  }catch(e){
    help.style.display='flex';
    return false;
  }
}
function stopScan(){
  running=false;
  if(rafId){cancelAnimationFrame(rafId);rafId=null;}
  if(frameCB && video.cancelVideoFrameCallback){video.cancelVideoFrameCallback(frameCB);frameCB=null;}
  if(currentStream){currentStream.getTracks().forEach(t=>t.stop());currentStream=null;}
}

/* ---------- Torch ---------- */
async function setTorch(on){
  const track=currentStream && currentStream.getVideoTracks()[0]; if(!track) return;
  const caps=track.getCapabilities && track.getCapabilities();
  if(caps && 'torch' in caps){
    try{ await track.applyConstraints({advanced:[{torch:on}]}); torchOn=on; flashBtn.classList.toggle('on',on); toastMsg(on?'Flash on':'Flash off'); }catch{}
  } else { toastMsg('Flash not supported'); }
}

/* ---------- Scan engines ---------- */
const barcode = (()=>{
  try{ if('BarcodeDetector' in window) return new window.BarcodeDetector({formats:['qr_code']}); }
  catch(_){}
  return null;
})();
const canvas=document.createElement('canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});

function handleResult(txt){
  const data=(txt||'').trim();
  if(!data||data===lastText) return;
  lastText=data;

  // âœ… STOP EVERYTHING BEFORE showing loader/iframe
  isScannerActive = false;   // <â€” block watchdog
  stopScan();

  hapticSuccess(); beep();
  openViewer(data);
}

function startLoops(){
  running=true; lastText='';
  usingBarcodeDetector = !!barcode;
  if(usingBarcodeDetector){
    const tick=()=>{ if(!running) return;
      barcode.detect(video).then(codes=>{
        if(!running) return;
        if(codes && codes.length) handleResult(codes[0].rawValue);
      }).catch(()=>{});
      schedule();
    };
    const schedule=()=>{
      if(!running) return;
      if(video.requestVideoFrameCallback){
        frameCB = video.requestVideoFrameCallback(()=>tick());
      }else{
        rafId = requestAnimationFrame(()=>setTimeout(tick,60));
      }
    };
    schedule();
  }else{
    let last=0;
    const step=(now)=>{
      if(!running) return;
      if(now-last<80){ rafId=requestAnimationFrame(step); return; }
      last=now;
      const vw=video.videoWidth,vh=video.videoHeight;
      if(vw&&vh){
        const size=Math.min(vw,vh),sx=(vw-size)/2,sy=(vh-size)/2,OUT=480;
        canvas.width=OUT;canvas.height=OUT;
        ctx.drawImage(video,sx,sy,size,size,0,0,OUT,OUT);
        const img=ctx.getImageData(0,0,OUT,OUT);
        const res=jsQR(img.data,OUT,OUT,{inversionAttempts:"dontInvert"});
        if(res && res.data){ handleResult(res.data); return; }
      }
      rafId=requestAnimationFrame(step);
    };
    rafId=requestAnimationFrame(step);
  }
}

/* ---------- Watchdogs (respect mode) ---------- */
function monitorCamera(){
  if(!isScannerActive) return; // do nothing when viewer/start visible
  const track=currentStream && currentStream.getVideoTracks()[0];
  if(!track || track.readyState==='ended' || video.readyState<2){ startCamera().catch(()=>{}); }
}
document.addEventListener('visibilitychange',()=>{ if(!document.hidden) monitorCamera(); });
navigator.mediaDevices && navigator.mediaDevices.addEventListener?.('devicechange', monitorCamera);
setInterval(monitorCamera, 2000);

/* ---------- Viewer ---------- */
function openViewer(url){
  viewer.style.display='block';
  loader.classList.add('active'); frame.style.opacity='0';
  try{ const u=new URL(url); if(!u.searchParams.has('scale')) u.searchParams.set('scale','1.0'); url=u.toString(); }catch{}
  frame.src=url;
}
frame.onload=()=>{ loader.classList.remove('active'); frame.style.opacity='1'; };

function backToScanner(){
  frame.src='about:blank';
  viewer.style.display='none';
  scanner.style.display='flex';
  isScannerActive = true;      // <â€” allow camera again
  startCamera();               // will start loops
}

/* ---------- UI ---------- */
startBtn.onclick=async ()=>{
  await ensureAudio();         // make sure beep is allowed right after user gesture
  start.style.display='none';
  scanner.style.display='flex';
  isScannerActive = true;
  await startCamera();
};
flashBtn.onclick=()=> setTorch(!torchOn);
soundBtn.onclick=()=>{ beepOn=!beepOn; soundBtn.classList.toggle('on',beepOn); };
backBtn.onclick=()=> backToScanner();
retryBtn.onclick=()=> { isScannerActive = true; startCamera(); };

/* Initial indicators */
flashBtn.classList.toggle('on', false);
soundBtn.classList.toggle('on', true);

/* Prevent pinch-zoom */
document.addEventListener('gesturestart', e=>e.preventDefault());
</script>
</body>
</html>
