<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Checkâ€‘in Scanner</title>

<!-- iOS Add-to-Home-Screen friendly -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icon-192.png" />

<style>
  :root {
    --bg: #f7f7f9;
    --fg: #0b0b0c;
    --muted: #6b7280;
    --tint: #0a84ff;        /* iOS blue */
    --ok: #34c759;          /* iOS green */
    --danger: #ff3b30;      /* iOS red */
    --card: rgba(255,255,255,0.9);
    --shadow: 0 10px 30px rgba(0,0,0,.08);
    --radius-xl: 22px;
    --radius-lg: 18px;
    --radius-md: 14px;
  }
  @supports (-webkit-touch-callout: none) {
    /* San Francisco on iOS */
    body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Arial, sans-serif; }
  }
  html, body { height: 100%; }
  body {
    margin: 0; background: linear-gradient(180deg,#ffffff 0%, #eef2f7 100%);
    color: var(--fg);
  }
  .app { min-height: 100%; display: grid; grid-template-rows: auto 1fr auto; }
  header {
    position: sticky; top: 0; z-index: 5; backdrop-filter: saturate(180%) blur(12px);
    background: rgba(255,255,255,0.7); border-bottom: 1px solid rgba(0,0,0,.06);
    padding: 14px 18px; font-weight: 800; letter-spacing: .2px;
  }
  .content { padding: 20px; }
  .center { display: grid; place-items: center; height: calc(100vh - 140px); }

  /* Big primary button */
  .btn {
    -webkit-tap-highlight-color: transparent;
    user-select: none; border: 0; cursor: pointer; font-weight: 800; letter-spacing: .2px;
    padding: 18px 22px; border-radius: 18px; box-shadow: var(--shadow); transition: transform .06s ease;
  }
  .btn:active { transform: translateY(1px) scale(.99); }
  .btn-primary { background: var(--tint); color: #fff; font-size: 18px; }
  .btn-plain { background: var(--card); color: var(--fg); }

  /* Cards */
  .card {
    background: var(--card); border: 1px solid rgba(0,0,0,.06); border-radius: var(--radius-xl); box-shadow: var(--shadow);
  }

  /* Scanner view */
  .scannerWrap { display: none; height: 100vh; grid-template-rows: auto 1fr auto; }
  .scannerWrap.show { display: grid; }
  .controls { display: flex; gap: 10px; padding: 14px 18px; }
  .pill { padding: 10px 14px; border-radius: 999px; background: var(--card); border: 1px solid rgba(0,0,0,.06); font-weight: 700; }

  /* Camera viewport */
  .cameraBox {
    margin: 0 18px 18px; position: relative; display: grid; place-items: center; height: min(64vh, 70vw);
    border-radius: 26px; overflow: hidden; background: #000; border: 1px solid rgba(0,0,0,.2);
    box-shadow: 0 14px 40px rgba(0,0,0,.20), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  video { width: 100%; height: 100%; object-fit: cover; transform: none; }

  /* Framing guides */
  .frame {
    position: absolute; inset: 0; pointer-events: none;
    background: radial-gradient(transparent 58%, rgba(0,0,0,.35) 62%);
  }
  .corners { position: absolute; inset: 10%; border-radius: 20px; border: 3px solid rgba(255,255,255,.85); mix-blend-mode: screen; }

  .status { text-align: center; color: var(--muted); font-size: 13px; padding: 4px 0 14px; }

  /* Modal sheet */
  .sheet { position: fixed; left: 0; right: 0; bottom: -60%; z-index: 50; background: var(--card);
           border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -12px 30px rgba(0,0,0,.18);
           border: 1px solid rgba(0,0,0,.06); padding: 18px; transition: bottom .22s ease; }
  .sheet.show { bottom: 0; }
  .sheet h3 { margin: 2px 0 10px; font-size: 18px; }
  .row { display: flex; gap: 10px; }
  .row .btn { flex: 1; }
  .urlbox { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #f3f4f6; border-radius: 12px; padding: 10px 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; border: 1px solid rgba(0,0,0,.06); }

  /* Top bar in scanner */
  .topbar { display:flex; align-items:center; gap:10px; padding:12px 16px; }
  .title { font-weight: 900; font-size: 17px; letter-spacing:.2px; }
  .ghost { background: transparent; border: 1px solid rgba(0,0,0,.08); color: var(--fg); }

  /* Tiny toast */
  #toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
           background: rgba(0,0,0,.85); color: #fff; padding: 8px 12px; border-radius: 12px; font-size: 13px; opacity: 0; transition: opacity .25s; }
  #toast.show { opacity: .92; }
</style>
</head>
<body>
<div class="app">
  <header>Checkâ€‘in</header>

  <!-- Start screen -->
  <main class="content">
    <div class="center">
      <div class="card" style="padding:28px 24px; text-align:center; max-width:520px;">
        <h1 style="margin:0 0 8px; font-size:28px;">Ready to scan</h1>
        <p style="margin:0 0 18px; color:var(--muted);">Scan tickets with the rear camera. You can enable the flash and sound later.</p>
        <button id="startBtn" class="btn btn-primary" style="width:100%">Start</button>
      </div>
    </div>
  </main>

  <footer style="padding:10px 18px; text-align:center; color:var(--muted); font-size:12px;">Add to Home Screen for a fullâ€‘screen experience.</footer>
</div>

<!-- Scanner view (separate "page") -->
<div id="scanner" class="scannerWrap">
  <div class="topbar">
    <button id="backBtn" class="btn ghost">â†©ï¸Ž Back</button>
    <div class="title">Scanner</div>
  </div>
  <div class="cameraBox">
    <video id="video" playsinline></video>
    <div class="frame"></div>
    <div class="corners"></div>
  </div>
  <div class="controls">
    <button id="flashBtn" class="pill">ðŸ”¦ Flash</button>
    <button id="soundBtn" class="pill">ðŸ”Š Sound on</button>
  </div>
  <div class="status" id="status">Point the camera at a QR code.</div>
</div>

<!-- Action sheet after a scan -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true">
  <h3>Open link?</h3>
  <div id="url" class="urlbox">â€”</div>
  <div style="height:10px"></div>
  <div class="row">
    <button id="openBtn" class="btn btn-primary">Open</button>
    <button id="closeBtn" class="btn btn-plain">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<!-- ZXing decoder -->
<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
  // Simple router between Start and Scanner
  const app = document.querySelector('.app');
  const startBtn = document.getElementById('startBtn');
  const scannerView = document.getElementById('scanner');
  const backBtn = document.getElementById('backBtn');
  const video = document.getElementById('video');
  const flashBtn = document.getElementById('flashBtn');
  const soundBtn = document.getElementById('soundBtn');
  const statusEl = document.getElementById('status');
  const sheet = document.getElementById('sheet');
  const urlBox = document.getElementById('url');
  const openBtn = document.getElementById('openBtn');
  const closeBtn = document.getElementById('closeBtn');
  const toast = document.getElementById('toast');

  let audioCtx, beepOn = true, currentStream, currentDeviceId = null, torchOn = false, reader;
  let lastText = '', loopActive = false;

  function toastMsg(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1100); }

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') return audioCtx.resume();
    return Promise.resolve();
  }
  function beep(ok=true){
    if (!beepOn) return;
    ensureAudio().then(()=>{
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.value = ok? 880 : 440;
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.22, audioCtx.currentTime+0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.14);
      o.start(); o.stop(audioCtx.currentTime+0.16);
    }).catch(()=>{});
  }

  async function startCamera(){
    if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
    const preferEnv = { video: { facingMode: { ideal: 'environment' } } };
    try {
      currentStream = await navigator.mediaDevices.getUserMedia(preferEnv);
    } catch(e){
      currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
    }
    video.srcObject = currentStream;
    await video.play();
    const track = currentStream.getVideoTracks()[0];
    const settings = track.getSettings();
    if (settings.deviceId) currentDeviceId = settings.deviceId;
    // Reset torch state
    torchOn = false; await setTorch(false);
  }

  async function setTorch(on){
    const track = currentStream && currentStream.getVideoTracks()[0];
    if (!track) return;
    const caps = track.getCapabilities && track.getCapabilities();
    if (caps && 'torch' in caps) {
      try { await track.applyConstraints({ advanced: [{ torch: on }] }); torchOn = on; toastMsg(on?'Flash on':'Flash off'); }
      catch {}
    } else {
      toastMsg('Flash not supported');
    }
  }

  async function startScanner(){
    await ensureAudio();
    await startCamera();
    reader = new ZXingBrowser.BrowserMultiFormatReader();
    loopActive = true; lastText = '';
    statusEl.textContent = 'Scanningâ€¦';

    const decode = async () => {
      if (!loopActive) return;
      try {
        const result = await reader.decodeOnceFromVideoElement(video);
        if (result && result.text) {
          const txt = result.text.trim();
          if (txt && txt !== lastText) {
            lastText = txt; beep(true);
            urlBox.textContent = txt;
            sheet.classList.add('show');
          }
        }
      } catch (e) {
        // continue looping
      }
      requestAnimationFrame(decode);
    };
    decode();
  }

  function stopScanner(){
    loopActive = false;
    if (reader) { try { reader.reset(); } catch(_){} }
    if (currentStream) { currentStream.getTracks().forEach(t=>t.stop()); currentStream = null; }
  }

  // UI events
  startBtn.addEventListener('click', () => {
    document.querySelector('.app').style.display='none';
    scannerView.classList.add('show');
    startScanner();
  });

  backBtn.addEventListener('click', () => {
    stopScanner();
    scannerView.classList.remove('show');
    document.querySelector('.app').style.display='grid';
  });

  flashBtn.addEventListener('click', () => setTorch(!torchOn));

  soundBtn.addEventListener('click', () => {
    beepOn = !beepOn; soundBtn.textContent = beepOn ? 'ðŸ”Š Sound on' : 'ðŸ”‡ Sound off';
    toastMsg(beepOn ? 'Sound on' : 'Sound off');
  });

  openBtn.addEventListener('click', () => {
    const href = urlBox.textContent.trim();
    sheet.classList.remove('show');
    // Try to navigate in the same tab (works well inside standalone A2HS)
    try { new URL(href); window.location.href = href; } catch { toastMsg('Invalid URL'); }
  });

  closeBtn.addEventListener('click', () => {
    sheet.classList.remove('show');
    // Allow scanning same code again after closing
    setTimeout(()=>{ lastText=''; }, 350);
  });

  // Prevent accidental zoom in standalone
  document.addEventListener('gesturestart', e => e.preventDefault());
</script>
</body>
</html>
